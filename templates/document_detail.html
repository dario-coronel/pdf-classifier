{% extends "base.html" %}

{% block title %}Detalle del Documento - PDF Classifier{% endblock %}
{% block page_title %}Detalle del Documento #{{ document.id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mb-4">
        <!-- PDF Viewer -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-file-pdf"></i> Documento Original
                </h6>
            </div>
            <div class="card-body">
                <div style="height: 600px; position: relative;">
                    {# Determinar carpeta según estado y normalizar nombre #}
                    {% if document.status == 'pending' or document.status == 'classified' %}
                        {% set pdf_url = "/uploads/pending/" + document.filename|urlencode %}
                        <iframe src="{{ pdf_url }}" type="application/pdf" width="100%" height="100%" style="border: none;">
                            <p>Su navegador no puede mostrar el PDF. 
                                <a href="{{ pdf_url }}" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="fas fa-download"></i> Descargar PDF
                                </a>
                            </p>
                        </iframe>
                        <div class="mt-2">
                            <a href="{{ pdf_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt"></i> Abrir en nueva pestaña
                            </a>
                        </div>
                    {% elif document.status == 'validated' %}
                        {% set pdf_url = "/uploads/classified/" + document.document_type.name|urlencode + "/" + document.filename|urlencode %}
                        <iframe src="{{ pdf_url }}" type="application/pdf" width="100%" height="100%" style="border: none;">
                            <p>Su navegador no puede mostrar el PDF. 
                                <a href="{{ pdf_url }}" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="fas fa-download"></i> Descargar PDF
                                </a>
                            </p>
                        </iframe>
                        <div class="mt-2">
                            <a href="{{ pdf_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt"></i> Abrir en nueva pestaña
                            </a>
                        </div>
                    {% else %}
                        <span class="text-danger">No se puede mostrar el PDF para este estado.</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Document Information -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-info-circle"></i> Información del Documento
                </h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Nombre Original:</div>
                    <div class="col-sm-8">{{ document.original_filename }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Tipo de Documento:</div>
                    <div class="col-sm-8">
                        {% if document.document_type %}
                        <span class="badge bg-info">{{ document.document_type.name }}</span>
                        {% else %}
                        <span class="text-muted">Sin clasificar</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Estado:</div>
                    <div class="col-sm-8">
                        {% if document.status == 'validated' %}
                        <span class="badge bg-success">Validado</span>
                        {% elif document.status == 'classified' %}
                        <span class="badge bg-warning">Clasificado</span>
                        {% elif document.status == 'pending' %}
                        <span class="badge bg-secondary">Pendiente</span>
                        {% elif document.status == 'error' %}
                        <span class="badge bg-danger">Error</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Confianza:</div>
                    <div class="col-sm-8">
                        {% if document.confidence_score %}
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar 
                                {% if document.confidence_score > 0.7 %}bg-success
                                {% elif document.confidence_score > 0.5 %}bg-warning
                                {% else %}bg-danger{% endif %}"
                                role="progressbar"
                                style="width: {{ (document.confidence_score * 100)|round }}%">
                                {{ (document.confidence_score * 100)|round }}%
                            </div>
                        </div>
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Tamaño del Archivo:</div>
                    <div class="col-sm-8">{{ (document.file_size / 1024)|round(2) }} KB</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Fecha de Carga:</div>
                    <div class="col-sm-8">{{ document.created_at.strftime('%d/%m/%Y %H:%M:%S') }}</div>
                </div>
                {% if document.processed_at %}
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Fecha de Procesamiento:</div>
                    <div class="col-sm-8">{{ document.processed_at.strftime('%d/%m/%Y %H:%M:%S') }}</div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Extracted Data -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-database"></i> Datos Extraídos
                </h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">CUIT:</div>
                    <div class="col-sm-8">{{ document.cuit or '-' }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Proveedor:</div>
                    <div class="col-sm-8">{{ document.provider or '-' }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Fecha del Documento:</div>
                    <div class="col-sm-8">
                        {{ document.document_date.strftime('%d/%m/%Y') if document.document_date else '-' }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Número de Documento:</div>
                    <div class="col-sm-8">{{ document.document_number or '-' }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 font-weight-bold">Monto Total:</div>
                    <div class="col-sm-8">
                        {% if document.total_amount %}
                        ${{ "{:,.2f}".format(document.total_amount) }}
                        {% else %}
                        -
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Extracted Text -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-file-alt"></i> Texto Extraído
                </h6>
            </div>
            <div class="card-body">
                <div style="max-height: 400px; overflow-y: auto;">
                    <pre class="bg-light p-3 rounded">{{ document.extracted_text or 'No hay texto extraído' }}</pre>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Actions -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-cogs"></i> Acciones
                </h6>
            </div>
            <div class="card-body">
                <button class="btn btn-primary w-100 mb-2" onclick="window.print()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary w-100 mb-2">
                    <i class="fas fa-arrow-left"></i> Volver al Dashboard
                </a>
                <a href="{{ url_for('pending_documents') }}" class="btn btn-outline-primary w-100 mb-2">
                    <i class="fas fa-clipboard-check"></i> Regresar al Menú Validar Documentos
                </a>
                {% if not document.is_validated %}
                <hr>
                <button class="btn btn-success w-100" onclick="showValidateModal()">
                    <i class="fas fa-check"></i> Validar Documento
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Error Message -->
        {% if document.error_message %}
        <div class="card shadow border-danger">
            <div class="card-header py-3 bg-danger text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-exclamation-triangle"></i> Error
                </h6>
            </div>
            <div class="card-body">
                <p class="text-danger mb-0">{{ document.error_message }}</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Validation Modal -->
<div class="modal fade" id="validateModal" tabindex="-1" aria-labelledby="validateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validateModalLabel">Validar Documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="validateForm">
                    <div class="mb-3">
                        <label for="documentType" class="form-label">Tipo de Documento</label>
                        <select class="form-select" id="documentType" required>
                            <option value="">Seleccione un tipo...</option>
                            <option value="Factura" {% if document.predicted_type and document.predicted_type.name == 'Factura' %}selected{% endif %}>Factura</option>
                            <option value="Nota de Credito" {% if document.predicted_type and document.predicted_type.name == 'Nota de Credito' %}selected{% endif %}>Nota de Crédito</option>
                            <option value="Nota de Debito" {% if document.predicted_type and document.predicted_type.name == 'Nota de Debito' %}selected{% endif %}>Nota de Débito</option>
                            <option value="Remito" {% if document.predicted_type and document.predicted_type.name == 'Remito' %}selected{% endif %}>Remito</option>
                            <option value="Desconocido" {% if document.predicted_type and document.predicted_type.name == 'Desconocido' %}selected{% endif %}>Desconocido</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="validatedBy" class="form-label">Validado por</label>
                        <input type="text" class="form-control" id="validatedBy" value="Usuario" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="validateDocument()">Validar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showValidateModal() {
        var modal = new bootstrap.Modal(document.getElementById('validateModal'));
        modal.show();
    }

    function validateDocument() {
        const docType = document.getElementById('documentType').value;
        const user = document.getElementById('validatedBy').value;

        if (!docType) {
            showToast('Por favor seleccione un tipo de documento', 'warning');
            return;
        }

        fetch('/api/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                document_id: {{ document.id }},
                document_type: docType,
                user: user
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Documento validado correctamente', 'success');
                // small delay to allow the toast to appear before reloading
                setTimeout(() => location.reload(), 900);
            } else {
                showToast('Error al validar documento: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error al validar documento', 'danger');
        });
    }
</script>
{% endblock %}
